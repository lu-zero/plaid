{%- macro paginate(pagination, endpoint) -%}
    {% if pagination.pages > 1 %}
    <ul class="pagination pagination-sm">
    {%- for page in pagination.iter_pages() %}
        {% if page %}
            <li {{ 'class=active' if page == pagination.page }} >
                <a href="{{ endpoint(page) }}"
                   title="">{{ page }}</a>
            </li>
        {% else %}
            <li><span>â€¦</span></li>
        {% endif %}
    {%- endfor %}
    </ul>
    {% endif %}
{% endmacro %}

{%- macro render_tag(tag, project) -%}
    <a class="btn btn-xs btn-info"i
       href="{{ url_for('project.tag', project_name=project.name, tag_name=tag.name) }}">{{tag.name}}</a>
{% endmacro %}

{%- macro render_tags(tags, project) -%}
    {%- for tag in tags %}
        {{ render_tag(tag, project) }}
    {% endfor %}
{% endmacro %}

{%- macro render_patch_state(patch) -%}
{% set css_class = 'alert-info' %}
    <span class="badge {{css_class}}">{{ patch.state.name }} </span>
{% endmacro %}

{%- macro patches_bulk_table_line(current_user) -%}
{% if current_user.has_role('committer') or current_user.has_role('admin') %}
<tr><td colspan="4"><a href="javascript:$('.patch-checkbox').prop('checked', true);">select all</a> - <a href="javascript:$('.patch-checkbox').prop('checked', false);">clear</a> -
    <select id="states" name="new_state">
        <option value='' ></option>
        <option value='U' >unreviewed</option>
        <option value="C" >commented</option>
        <option value="A" >accepted</option>
        <option value="R" >rejected</option>
    </select>
    <a href="#" id="bulk_apply">apply</a>
</td></tr>
{% endif %}
{% endmacro %}

{%- macro patches_bulk_script() -%}
<script>
    $("#bulk_apply").click(function() {
        var selected=$('.patch-checkbox').filter(function(i){return $('.patch-checkbox')[i].checked;});
        var values=$.map(selected, function(el, i){return el.value;});
        var newState = $( "#states option:selected" )[0].value;
        if (values.length > 0 && newState.length > 0) {
            var valuesStr = values.join(',');
            $('<form action="{{ url_for('project.bulk_change_state') }}" method="POST">' +
                '<input type="hidden" name="patches" value="' + valuesStr + '">' +
                '<input type="hidden" name="new_state" value="' + newState + '">' +
                '</form>').submit();
        }
    });
</script>
{% endmacro %}

{%- macro patch_row_tiny(patch, current_user) -%}
    <tr>
        {% if current_user.has_role('committer') or current_user.has_role('admin') %}
        <td><input type="checkbox" class="patch-checkbox" name="patch" value="{{ patch.id }}"></td>
        {% endif %}
        <td>
            {{ render_tags(patch.tags, patch.project) }}
            <a href="{{url_for('patch.index', patch_id=patch.id)}}">
                {{ patch.name| truncate(79, True) }}
            </a>
        </td>
        <td>
            {{ patch.date }}
        </td>
        <td>
            {{ render_patch_state(patch) }}
        </td>
    </tr>
{% endmacro %}

{%- macro patch_list(patches, current_user) -%}
    <table class="table table-striped">
        <thead>
            {{ patches_bulk_table_line(current_user) }}
            <tr>
                {% if current_user.has_role('committer') or current_user.has_role('admin') %}
                <th></th>
                {% endif %}
                <th>Patch</th>
                <th>Date</th>
                <th>State</th>
            </tr>
        </thead>
        <tbody>
        {%- for patch in patches %}
            {{ patch_row_tiny(patch, current_user) }}
        {% endfor %}
        </tbody>
    </table>
    {{ patches_bulk_script() }}
{% endmacro %}

{%- macro render_patches(patches, endpoint) -%}

{{ paginate(patches, endpoint) }}

{{ patch_list(patches.items) }}

{{ paginate(patches, endpoint) }}

{% endmacro %}

{%- macro render_item(name, item) -%}
    {%- if item -%}
        <tr>
            <th>{{name}}</th>
            <td><a href="{{ item }}">{{ item }}</a></td>
        </tr>
    {% endif %}
{% endmacro %}

{%- macro render_badge(text, item, css_class, url) -%}
    <a href="{{ url }}" class="badge {{css_class}}">
        {{ text }} {{ item.count() }}
    </a>
{% endmacro %}

{%- macro render_status(p) -%}
    {{ render_badge("New", p.new_patches, "alert-info",
                    url_for('project.patches', group='new')) }}
    {{ render_badge("Committed", p.committed_patches, "alert-success",
                    url_for('project.patches', group='committed')) }}
    {{ render_badge("Reviewed", p.reviewed_patches, "alert-warning",
                    url_for('project.patches', group='reviewed')) }}
    {{ render_badge("Stale", p.stale_patches, "alert-danger",
                    url_for('project.patches', group='stale')) }}
{% endmacro %}
